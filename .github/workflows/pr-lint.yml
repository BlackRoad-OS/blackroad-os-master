name: PR Lint

# This workflow ensures PR titles and content follow BlackRoad OS conventions

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-title-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            
            // Expected format: [area] Description or Type: Description
            const patterns = [
              /^\[[\w-]+\]\s+.+/,  // [area] Description
              /^(feat|fix|chore|docs|refactor|test|style|perf|ci|build)(\(.+\))?:\s+.+/i  // Conventional commits
            ];
            
            const isValid = patterns.some(pattern => pattern.test(title));
            
            if (!isValid) {
              core.setFailed(
                'PR title does not follow conventions.\n' +
                'Expected formats:\n' +
                '- [area] Description (e.g., "[core] Add health endpoint")\n' +
                '- Type: Description (e.g., "feat: Add new API endpoint")\n' +
                'Current title: ' + title
              );
            } else {
              console.log('✅ PR title format is valid');
            }

  pr-size-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;
            
            console.log(`PR changes: +${additions} -${deletions} (total: ${totalChanges})`);
            
            // Warn if PR is large (>500 lines changed)
            if (totalChanges > 500) {
              core.warning(
                `⚠️ This PR is large (${totalChanges} lines changed).\n` +
                'Consider breaking it into smaller, atomic PRs for easier review.'
              );
            } else {
              console.log('✅ PR size is reasonable');
            }

  pr-checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description checklist
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            
            // Check if checklist items are present
            const hasChecklist = /- \[[ x]\]/.test(body);
            
            if (!hasChecklist) {
              core.warning(
                '⚠️ PR description does not contain a checklist.\n' +
                'Please use the PR template and fill out the checklist.'
              );
            } else {
              console.log('✅ PR contains checklist items');
              
              // Count completed vs total items
              const totalItems = (body.match(/- \[[ x]\]/g) || []).length;
              const completedItems = (body.match(/- \[x\]/g) || []).length;
              console.log(`Checklist: ${completedItems}/${totalItems} items completed`);
            }
